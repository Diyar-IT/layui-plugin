<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="layui/css/layui.css"/>
    <title>Photos Pro</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        .container {
            padding: 20px;
            margin: 0 auto;
        }
    </style>

    <script type="text/javascript" src="layui/layui.js"></script>
    <script type="text/javascript" src="common.js"></script>
</head>
<body>
<div class="container">
    <blockquote class="layui-elem-quote">
        layer说明文档没有相关mousedown，mousemove回调函数所以实现相册功能增加了moveStart和moving调用函数。<br>
    </blockquote>
    <pre lay-title="" class="layui-code javascript" lay-options="{lang: 'javascript'}">
      <textarea>//mousedown调用函数代码， 大概720~750行左右
config.moveStart && typeof config.moveStart === 'function' && config.moveStart(layero,e);

//注：拖动时跟随鼠标位置上面增加mousemove调用函数代码， 大概800~820行左右
if (config.pullSwitch && config.moving && typeof config.moving === 'function') {
  config.moving({layero, rect: {left: X, top: Y}, event: e, config: config});
  return false;
}</textarea>
    </pre>


</div>
<div class="container">
    <blockquote class="layui-elem-quote">
        重写的相册代码
    </blockquote>
<pre lay-title="" class="layui-code javascript" lay-options="{lang: 'javascript'}">
    <textarea>
  // 相册层
  layer.photos = function (options, loop) {
    var dict = {};
    options = options || {};
    if (!options.photos) return;

    // 若 photos 并非选择器或 jQuery 对象，则为普通 object
    var isObject = !(typeof options.photos === 'string' || options.photos instanceof $);
    var photos = isObject ? options.photos : {};
    var data = photos.data || [];
    var start = photos.start || 0;

    dict.imgIndex = (start | 0) + 1;
    dict.images = {};
    dict.distance = 140;
    options.img = options.img || 'img';
    options.thumbBar = options.thumbBar || false;
    options.srcUseThumb = options.srcUseThumb || false;

    // 若 options.photos 不是一个对象
    if (!isObject) { // 页面直接获取
      var parent = $(options.photos);
      var pushData = function () {
        data = [];
        parent.find(options.img).each(function (index) {
          var othis = $(this);
          othis.attr('layer-index', index);
          data.push({
            alt: othis.attr('alt'),
            pid: othis.attr('layer-pid'),
            src: othis.attr('lay-src') || othis.attr('src'),
            thumb: othis.attr('src')
          });
        });
      };

      pushData();

      if (data.length === 0) return;

      parent.on('click', options.img, function () {
        var othis = $(this), index = othis.attr('layer-index');
        layer.photos($.extend(options, {
          photos: {
            start: index,
            data: data,
            tab: options.tab
          }
        }));
      });

      // 不直接弹出
      if (!loop) return;

    } else if (data.length === 0) {
      return layer.msg('&#x6CA1;&#x6709;&#x56FE;&#x7247;');
    }

    // 上一张
    dict.imgprev = function (key) {
      dict.imgIndex--;
      if (dict.imgIndex < 1) {
        dict.imgIndex = data.length;
      }
      dict.switchImage(key);
      //dict.restImageAttr(dict.imgIndex + 1);
      if (options.thumbBar){
        dict.setListScroll(dict.layero.find('.layui-layer-images-thumb-item[data-index="'+ (dict.imgIndex - 1) +'"]'));
      }
    };

    // 下一张
    dict.imgnext = function (key, errorMsg) {
      dict.imgIndex++;
      if (dict.imgIndex > data.length) {
        dict.imgIndex = 1;
        if (errorMsg) {
          return
        }
      }
      dict.switchImage(key);

      if (options.thumbBar){
        dict.setListScroll(dict.layero.find('.layui-layer-images-thumb-item[data-index="'+ (dict.imgIndex - 1) +'"]'));
      }
      //dict.restImageAttr(dict.imgIndex - 1);
    };

    // 设置thumb位置
    dict.setListScroll = function (elem) {
      var listElem = elem.parents('.layui-layer-images-thumb');
      var autoLeft = elem.outerWidth() * dict.imgIndex - 1;
      listElem.animate({
        scrollLeft: autoLeft - listElem.width() / 3
      }, 200);
      elem.addClass('active').siblings().removeClass('active');
    }

    // 还原图片属性
    dict.restImageAttr = function (index) {
      var img = dict.layero.find('.layer-photos-pictures img[data-index="'+ index +'"]');
      if (img[0]){
        var image = dict.images[index];
        image.scaleX = 1;
        image.rotate = 0;
        image.width = image.oldWidth;
        image.height = image.oldHeight;
        img.css({
          width: image.oldWidth,
          height: image.oldHeight,
          transform: 'none'
        });
      }
    }

    // 方向键
    dict.keyup = function (event) {
      if (!dict.end) {
        var code = event.keyCode;
        event.preventDefault();
        if (code === 37) {
          dict.imgprev(true);
        } else if (code === 39) {
          dict.imgnext(true);
        } else if (code === 27) {
          layer.close(dict.index);
        }
      }
    }

    // 切换
    dict.tabimg = function (key) {
      if (data.length <= 1) return;
      photos.start = dict.imgIndex - 1;
      layer.close(dict.index);
      return layer.photos(options, true, key);
    }

    // 判断数字
    dict.isNumber = function (n) {
      return typeof n === 'number' && !isNaN(n);
    }

    // 图片css样式
    dict.getTransform = function (options) {
      var transforms = [];
      var rotate = options.rotate;
      var scaleX = options.scaleX;

      if (dict.isNumber(rotate) && rotate !== 0) {
        transforms.push('rotate(' + rotate + 'deg)');
      }

      if (dict.isNumber(scaleX) && scaleX !== 1) {
        transforms.push('scaleX(' + scaleX + ')');
      }

      return transforms.length ? transforms.join(' ') : 'none';
    }

    // 重设窗口位置和大小
    dict.setArea = function (image) {
      var offsetTop = (win.height() - image.height) / 2;
      var offsetLeft = (win.width() - image.width) / 2;
      if (dict.isMove){
        offsetLeft = offsetLeft + (dict.layero.offset().left - offsetLeft);
        offsetTop = offsetTop + (dict.layero.offset().top - offsetTop);
      }
      // 设置坐标
      dict.layero.css({
        top: offsetTop,
        left: offsetLeft,
        width: dict.images[dict.imgIndex].width,
        height : dict.images[dict.imgIndex].height,
      });
    }

    //切换图片
    dict.switchImage = function () {
      if (data.length <= 1) return;
      var imgBox = dict.layero.find('.layer-photos-pictures');
      var isImage = imgBox.find('img[data-index="'+dict.imgIndex +'"]');
      dict.refreshImgaeInfo();
      if (isImage.length){
        isImage.removeClass('layui-hide').css({
          transform: 'none',
          width: dict.images[dict.imgIndex].oldWidth,
          height: dict.images[dict.imgIndex].oldHeight
        }).siblings().addClass('layui-hide');
        dict.getWinArea(isImage[0]);
        dict.setArea(isImage[0]);
      }else {
        imgBox.find('img').addClass('layui-hide');
        var image = data[dict.imgIndex - 1];
        dict.isMove = false;
        dict.loading();
        dict.loadImage(image.src, function (img) {
          dict.getWinArea(img);
          dict.setArea(img);
          imgBox.append('<img style="width: '+img.width+'px;height: '+img.height+'px;cursor: move;" data-index="'+dict.imgIndex+'" src="' + image.src + '" alt="' + (image.alt || '') + '" layer-pid="' + (image.pid || '') + '"/>');
          layer.close(dict.loadi);
        });
      }
      options.tab && typeof options.tab === 'function' && options.tab(data[dict.imgIndex], dict.layero);
    }

    //更新底部图片信息
    dict.refreshImgaeInfo = function () {
      var img = data[dict.imgIndex - 1];
      var html = [
        '<h3>'+ (img.alt || '') +'</h3>',
        '<em>'+ dict.imgIndex +' / '+ data.length +'</em>',
        '<a href="'+ img.src +'" target="_blank">查看原图</a>'
      ].join('');
      dict.layero.find('.layui-layer-imgtit').html(html);
    }

    // 事件
    dict.event = function () {
      /*
      dict.bigimg.hover(function(){
        dict.imgsee.show();
      }, function(){
        dict.imgsee.hide();
      });
      */
      dict.bigimg.find('.layui-layer-imgprev').on('click', function (event) {
        event.preventDefault();
        dict.imgprev(true);
      });

      dict.bigimg.find('.layui-layer-imgnext').on('click', function (event) {
        event.preventDefault();
        dict.imgnext(true);
      });

      $(document).on('keyup', dict.keyup);

      var scalexFlag = true;
      //工具栏事件
      dict.layero.off('click').on('click', '*[toolbar-event]', function () {
        var othis = $(this), event = othis.attr('toolbar-event');
        var img = dict.layero.find('.layer-photos-pictures img[data-index="'+dict.imgIndex +'"]');
        var image = dict.images[dict.imgIndex];
        switch (event) {
          case 'rotate':
            image.rotate = ((image.rotate || 0) + Number(othis.attr('data-option'))) % 360;
            img.css({
              transform: dict.getTransform(image)
            });
            break;
          case 'scalex':
            if (scalexFlag) {
              image.scaleX = -1;
              scalexFlag = false;
            } else {
              image.scaleX = 1;
              scalexFlag = true;
            }
            scalexFlag !== scalexFlag;
            img.css({
              transform: dict.getTransform(image)
            });
            break;
          case 'zoom':
            var ratio = Number(othis.attr('data-option'));
            if (ratio < 0) {
              ratio = 1 / (1 - ratio);
            } else {
              ratio = 1 + ratio;
            }
            image.width = image.width * ratio;
            image.height = image.height * ratio;
            img.css({
              width: image.width,
              height: image.height,
              transform: dict.getTransform(image)
            });
            dict.setArea(image);
            break;
          case 'reset':
            scalexFlag = true;
            dict.isMove = false;
            image.scaleX = 1;
            image.rotate = 0;
            image.width = image.oldWidth;
            image.height = image.oldHeight;
            img.css({
              width: image.oldWidth,
              height: image.oldHeight,
              transform: 'none'
            });
            dict.setArea(image);
            break;
          case 'close':
            layer.close(dict.index);
            break;
        }
      });

      // 缩略图点击事件
      dict.layero.on('click', '.layui-layer-images-thumb-item', function () {
        var othis = $(this);
        var index = parseInt(othis.attr('data-index'));
        if (index === dict.imgIndex - 1) return;
        dict.imgIndex = index + 1;
        dict.setListScroll(othis);
        dict.switchImage();
        //dict.restImageAttr(index > dict.imgIndex ? index - 1 : index + 1);
      })
    };

    // 加载动画
    dict.loading = function () {
      dict.loadi =  layer.load(1, {
        shade: dict.index ? 0 : ('shade' in options ? false : 0.9),
        scrollbar: false
      });
    }

    // 加载图片
    dict.loadImage = function (url, callback) {
      var img = new Image();
      img.src = url;
      if (img.complete) {
        return callback(img);
      }
      img.onload = function () {
        img.onload = null;
        callback(img);
      };
      img.onerror = function (e) {
        img.onerror = null;
        dict.error(e);
      };
    }

    //若实际图片的宽或者高比
    dict.getWinArea = function (img) {
      var imgarea = [img.width, img.height];
      var winarea = [win.width() - 100, win.height() - 100];

      // 若实际图片的宽或者高比 屏幕大（那么进行缩放）
      if (!options.full && (imgarea[0] > winarea[0] || imgarea[1] > winarea[1])) {
        var wh = [imgarea[0] / winarea[0], imgarea[1] / winarea[1]];// 取宽度缩放比例、高度缩放比例
        if (wh[0] > wh[1]) {// 取缩放比例最大的进行缩放
          imgarea[0] = imgarea[0] / wh[0];
          imgarea[1] = imgarea[1] / wh[0];
        } else if (wh[0] < wh[1]) {
          imgarea[0] = imgarea[0] / wh[1];
          imgarea[1] = imgarea[1] / wh[1];
        }
      }

      dict.images[dict.imgIndex] = {
        oldWidth: imgarea[0],
        oldHeight: imgarea[1],
        width: imgarea[0],
        height: imgarea[1],
      };

      return [imgarea[0] + 'px', imgarea[1] + 'px'];
    }

    // 错误信息
    dict.error = function (e) {
      layer.close(dict.loadi);
      layer.msg('&#x5F53;&#x524D;&#x56FE;&#x7247;&#x5730;&#x5740;&#x5F02;&#x5E38;<br>&#x662F;&#x5426;&#x7EE7;&#x7EED;&#x67E5;&#x770B;&#x4E0B;&#x4E00;&#x5F20;&#xFF1F;', {
        time: 30000,
        btn: ['&#x4E0B;&#x4E00;&#x5F20;', '&#x4E0D;&#x770B;&#x4E86;'],
        yes: function () {
          data.length > 1 && dict.imgnext(true, true);
        }
      });
    }
    //获取移动方向
    dict.getMoveDirection = function (x1, x2, y1, y2) {
      return Math.abs(x1 - x2) >= Math.abs(y1 - y2) ? (x1 - x2 > 0 ? 'Left' : 'Right') : (y1 - y2 > 0 ? 'Up' : 'Down');
    }

    // 首次打开相册
    dict.loading();
    dict.loadImage(data[start].src, function (img) {
      layer.close(dict.loadi);
      // 弹出图片层
      dict.index = layer.open($.extend({
        type: 1,
        id: 'layui-layer-photos',
        area: dict.getWinArea(img),
        title: false,
        shade: 0.9,
        shadeClose: true,
        closeBtn: false,
        move: '.layui-layer-phimg .layer-photos-pictures',
        moveType: 1,
        scrollbar: false,
        moveOut: true,
        anim: 5,
        isOutAnim: false,
        skin: 'layui-layer-photos' + skin('photos'),
        content: '<div class="layui-layer-phimg">'
          + '<div class="layer-photos-pictures"><img data-index="'+dict.imgIndex+'" src="' + (data[start].src) + '" alt="' + (data[start].alt || '') + '" layer-pid="' + (data[start].pid || '') + '" /></div>'
          + function () {
            var arr = ['<div class="layui-layer-imgsee">'];

            // 左右箭头翻页
            if (data.length > 1) {
              arr.push(['<div class="layui-layer-imguide">',
                '<span class="layui-icon layui-icon-left layui-layer-iconext layui-layer-imgprev"></span>',
                '<span class="layui-icon layui-icon-right layui-layer-iconext layui-layer-imgnext"></span>',
                '</div>'].join(''));
            }

            // 底部栏
            if (!options.hideFooter) {
              arr.push(['<div class="layui-layer-imgbar">',
                '<div class="layui-layer-imgtit">',
                '<h3>' + (data[start].alt || '') + '</h3>',
                '<em>' + dict.imgIndex + ' / ' + data.length + '</em>',
                '<a href="' + data[start].src + '" target="_blank">查看原图</a>',
                '</div>',
                '</div>'].join(''));
            }

            //缩略图栏
            if (options.thumbBar){
              arr.push([
                '<div class="layui-layer-images-thumb '+(!options.hideFooter ? 'onshow-footer' : '')+'">',
                '<div class="layui-layer-images-thumb-list">',
                (function () {
                  var items = [];
                  layui.each(data, function (index, item){
                    if (!options.srcUseThumb && !item.thumb) return;
                    items.push('<div data-index="'+index+'" class="layui-layer-images-thumb-item '+(dict.imgIndex -1 === index ? 'active' : '')+'" style="background-image: url('+( item.thumb || item.src )+')" />');
                  });
                  return items.join('');
                })(),
                '</div>',
                '</div>'
              ].join(''));
            }

            //工具栏
            if (options.toolbar) {
              arr.push([
                '<div class="layui-layer-images-toolbar">',
                '<div class="layer-images-tool-item">',
                '<span toolbar-event="rotate" data-option="-15" title="向左旋转15°" style="transform: scaleX(-1);"><i class="layui-icon layui-icon-refresh rotate"></i></span>',
                '<span toolbar-event="rotate" data-option="15" title="向右旋转15°"><i class="layui-icon layui-icon-refresh"></i></span>',
                '<span toolbar-event="scalex" title="翻转"><i class="layui-icon layui-icon-slider"></i></span>',
                '<span toolbar-event="zoom" data-option="0.1" title="放大图片"><i class="layui-icon layui-icon-add-circle"></i></span>',
                '<span toolbar-event="zoom" data-option="-0.1" title="缩小图片"><i class="layui-icon layui-icon-reduce-circle"></i></span>',
                '<span toolbar-event="reset" title="重置图片"><i class="layui-icon layui-icon-refresh-1"></i></span>',
                '<span toolbar-event="close" title="关闭"><i class="layui-icon layui-icon-close"></i></span>',
                '</div>',
                '</div>'
              ].join(''));
            }

            arr.push('</div>');
            return arr.join('');
          }()
          + '</div>',
        success: function (layero) {
          dict.layero = layero;
          dict.bigimg = layero.find('.layui-layer-phimg');
          dict.imgsee = layero.find('.layui-layer-imgbar');
          dict.isMove = false;
          if (options.toolbar) {
            layero.find('.layui-layer-content').addClass('layui-layer-images-toolbar-mode');
            dict.bigimg.find('img[data-index="'+dict.imgIndex+'"]').css({
              width: dict.images[dict.imgIndex].width,
              height: dict.images[dict.imgIndex].height
            });
          }
          dict.event();
          options.success && typeof options.success === 'function' && options.success(layero);
        },
        end: function () {
          dict.end = true;
          $(document).off('keyup', dict.keyup);
        },
        moveEnd: function(layero){
          dict.isMove = true;
          dict.isMoveX = dict.isMoveY = false;
          if (options.pullSwitch){
            dict.isMove = false;
            layero.css({top: dict.layeroOffsetTop, left: dict.layeroOffsetLeft });
          }
        },
        moveStart: function (layero, event) {
          if (!options.pullSwitch) return;
          dict.startPoints = {x: event.pageX, y: event.pageY};
          dict.layeroOffsetTop = layero[0].offsetTop;
          dict.layeroOffsetLeft = layero[0].offsetLeft;
        },
        moving: function (obj) {
          if (!options.pullSwitch) return;
          dict.direction = dict.getMoveDirection(dict.startPoints.x, obj.event.pageX, dict.startPoints.y, obj.event.pageY);
          if (dict.direction === 'Up' || dict.direction === 'Down'){
            if (dict.isMoveX) return;
            dict.isMoveY = true;
            obj.layero.css({top: obj.rect.top });
            if (Math.abs(obj.layero[0].offsetTop - dict.layeroOffsetTop) >= dict.distance){
              obj.config.anim = 0;
              obj.config.isOutAnim = true;
              layer.close(dict.index);
              return false;
            }
          }else {
            if (dict.isMoveY) return;
            dict.isMoveX = true;
            obj.layero.css({left: obj.rect.left });
            var moveDistance = Math.abs(obj.layero[0].offsetLeft - dict.layeroOffsetLeft);
            if (moveDistance > dict.images[dict.imgIndex].oldWidth / 3){
              var img = dict.layero.find('.layer-photos-pictures img[data-index="'+dict.imgIndex+'"]');
              var index = parseInt(img.attr('data-index')) - 1;
              if (dict.direction === 'Right' && data[index + 1]){
                img.addClass('layui-hide');
                dict.imgnext(true);
                $(document).mouseup();
                return false;
              }
              if (dict.direction === 'Left' && data[index - 1]){
                img.addClass('layui-hide');
                dict.imgprev(true);
                $(document).mouseup();
                return false;
              }
            }
          }
        }
      }, options));
    });
  };
    </textarea>
</pre>
</div>
<div class="container">
    <blockquote class="layui-elem-quote">
        相册相关样式
    </blockquote>
    <pre lay-title="" class="layui-code css" lay-options="{lang: 'css'}">
    <textarea>
/*photo工具栏*/
.layui-layer-images-toolbar{position: fixed;top: 0;left: 0;right: 0;height: 40px;background-color: #000\9;filter: Alpha(opacity=60);background-color: rgba(2,0,0,.35);display: flex;align-items: center;justify-content: center;color: white;}
.layui-layer-images-toolbar .layer-images-tool-item{position: relative;width: auto;height: 100%;display: flex;align-items: center;}
.layui-layer-images-toolbar .layer-images-tool-item span{padding: 8px 10px; transition: all .4s;cursor: pointer;}
.layui-layer-images-toolbar .layer-images-tool-item span:hover{background-color: rgba(64, 64, 64, 0.67);}
.layui-layer-images-toolbar .layer-images-tool-item span i{font-size: 22px;}
.layui-layer-photos .layui-layer-content.layui-layer-images-toolbar-mode{overflow: visible !important;}

.layui-layer-images-thumb{position: fixed;left: 0;right: 0;bottom: 0;height: 70px;overflow-x: auto;white-space: nowrap; transition: scroll 0.4s;}
.layui-layer-images-thumb::-webkit-scrollbar{display: none;}
.layui-layer-images-thumb.onshow-footer{bottom: 40px;}
.layui-layer-images-thumb .layui-layer-images-thumb-list{margin: 0 auto;display: inline-block;position: relative;}
.layui-layer-images-thumb .layui-layer-images-thumb-item{width: 60px;height: 60px;margin: 5px;cursor: pointer;background-repeat: no-repeat;background-size: cover;background-position: center;display: inline-block;border-radius: 4px;overflow: hidden;}
.layui-layer-images-thumb .layui-layer-images-thumb-item.active{outline: 2px #e42e00 solid;}
.layui-layer-images-thumb .layui-layer-images-thumb-item:hover{outline: 2px #eb5833 solid;}
    </textarea>
        </pre>
</div>
<script type="text/javascript">
  layui.use(['code', 'util', 'hljs'], function () {
    var $ = layui.$;

    layui.hljs.configure({
     classPrefix: 'light-'
    });

    layui.code({
      elem: '.layui-code.javascript',
      preview: false,
      layout: ['code', 'preview'],
      tools: ['full', 'copy'],
      skin: 'light',
      encode: false,
      codeParse: function (html) {
        return layui.hljs.highlight(html, {language: 'javascript'}).value;
      }
    });

    layui.code({
      elem: '.layui-code.css',
      preview: false,
      layout: ['code', 'preview'],
      tools: ['full', 'copy'],
      skin: 'light',
      encode: false,
      codeParse: function (html) {
        return layui.hljs.highlight(html, {language: 'css'}).value;
      }
    });

  });
</script>
</body>
</html>
